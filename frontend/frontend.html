<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="theme.css">
</head>
<body class="bg-white text-black dark:bg-black dark:text-gray-200 transition-colors duration-300">
    <div class="max-w-4xl mx-auto p-4">
        <header class="bg-[#06529c] text-white rounded-t-lg p-4 shadow-md">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center">
                        <i class="fa-solid fa-bug text-xl text-[#FCB813]"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Cybered CTF</h1>
                        <p class="text-xs text-gray-300">Can you get the flags</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="theme-toggle" aria-label="Switch to light mode" class="text-[#FCB813] hover:text-yellow-400 transition p-2 rounded-md">
                        <i class="fas fa-sun text-xl"></i>
                    </button>
                    <button id="clear-chat" class="text-[#FCB813] hover:text-yellow-400 transition flex items-center space-x-1 p-2 rounded-md">
                        <i class="fas fa-trash-alt text-xl"></i>
                        <span>Clear Chat</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="chat-container shadow-lg overflow-y-auto p-4" id="chat-window">
            </div>

        <div class="input-area-container-themed rounded-b-lg shadow-lg p-4">
            <form id="chat-form" class="flex space-x-2">
                <input
                    type="text"
                    id="user-input"
                    placeholder="Type your message here..."
                    class="user-input-themed flex-1 rounded-full py-3 px-4 focus:outline-none focus:ring-2 focus:ring-[#FCB813] dark:focus:ring-[#FCB813] focus:border-transparent"
                    autocomplete="off"
                >
                <button
                    type="submit"
                    class="bg-[#06529c] text-[#FCB813] rounded-full w-12 h-12 flex items-center justify-center hover:bg-[#EAA800] transition"
                >
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
            <div class="footer-text-themed mt-2 text-xs text-center">
                <p>Do not trust AI it can be wrong!</p>
            </div>
        </div>
    </div>

    <script>
    // Ensure this script is loaded after the DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Chat Assistant Script Loaded (Custom CSS Divs)"); // DEBUG

        // Get references to all necessary DOM elements
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const chatWindow = document.getElementById('chat-window');
        const clearChatBtn = document.getElementById('clear-chat');
        const themeToggle = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement; // Reference to the <html> tag

        if (!themeToggle) console.error("Theme toggle button not found!"); 
        if (!htmlElement) console.error("HTML element not found!"); 


        let currentChatMessages = [];
        const welcomeMessageHTML = `
        <div class="text-center py-8" id="welcome-message">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-700 flex items-center justify-center">
                <i class="fas fa-comments text-[#FCB813] text-2xl"></i>
            </div>
            <h2 class="text-xl font-medium mb-2 welcome-h2-themed">How can I help you today?</h2>
            <p class="text-sm max-w-md mx-auto welcome-p-themed">Ask me anything and I'll do my best to assist you with your questions.</p>
        </div>`;

        const sunIconClass = 'fa-sun'; 
        const moonIconClass = 'fa-moon'; 
        const toggleIconElement = themeToggle ? themeToggle.querySelector('i') : null; 
        if (!toggleIconElement) console.error("Toggle icon element (<i>) not found!"); 

        function applyThemePreference(theme) {
            console.log("Applying theme:", theme); 
            if (theme === 'dark') {
                htmlElement.classList.add('dark'); 
                if (toggleIconElement) {
                    toggleIconElement.classList.remove(moonIconClass); 
                    toggleIconElement.classList.add(sunIconClass);
                }
                if (themeToggle) themeToggle.setAttribute('aria-label', 'Switch to light mode');
            } else { 
                htmlElement.classList.remove('dark'); 
                if (toggleIconElement) {
                    toggleIconElement.classList.remove(sunIconClass); 
                    toggleIconElement.classList.add(moonIconClass);
                }
                if (themeToggle) themeToggle.setAttribute('aria-label', 'Switch to dark mode');
            }
            console.log("HTML classList after apply:", htmlElement.classList.toString()); 
        }

        if (themeToggle) {
            themeToggle.addEventListener('click', () => {
                console.log("Theme toggle clicked"); 
                const isDarkModeCurrently = htmlElement.classList.contains('dark');
                const newTheme = isDarkModeCurrently ? 'light' : 'dark';
                console.log("Current theme is dark:", isDarkModeCurrently, "New theme will be:", newTheme); 
                localStorage.setItem('theme', newTheme); 
                applyThemePreference(newTheme);
            });
        }

        let initialThemeToApply = 'dark'; 
        const savedThemeFromStorage = localStorage.getItem('theme');
        console.log("Saved theme from storage:", savedThemeFromStorage); 
        
        if (savedThemeFromStorage) {
            initialThemeToApply = savedThemeFromStorage; 
        }
        console.log("Initial theme to apply:", initialThemeToApply); 
        applyThemePreference(initialThemeToApply);

        const prefersDarkColorSchemeMedia = window.matchMedia('(prefers-color-scheme: dark)');
        if (prefersDarkColorSchemeMedia) {
            prefersDarkColorSchemeMedia.addEventListener('change', (e) => {
                console.log("OS theme preference changed. Matches dark:", e.matches); 
                if (!localStorage.getItem('theme')) { 
                    console.log("Applying OS theme preference as no user choice saved."); 
                    applyThemePreference(e.matches ? 'dark' : 'light');
                }
            });
        }

        loadChatHistory();
        
        if (chatForm) {
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const message = userInput.value.trim();
                if (message) {
                    addUserMessage(message); 
                    userInput.value = ''; 
                    sendMessageToBackend(message); 
                }
            });
        }
        
        if (clearChatBtn) {
            clearChatBtn.addEventListener('click', function() {
                localStorage.removeItem('chatMessagesArray'); 
                currentChatMessages = []; 
                if (chatWindow) chatWindow.innerHTML = welcomeMessageHTML; 
                const wm = document.getElementById('welcome-message');
                if (wm) wm.style.display = 'block'; 
                if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight; 
            });
        }
        
        function hideWelcomeMessage() {
            const wm = document.getElementById('welcome-message');
            if (wm) wm.style.display = 'none';
        }

        function _renderUserMessage(message) {
            hideWelcomeMessage();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end mb-4 message-animation';
            messageDiv.innerHTML = `
                <div class="max-w-xs md:max-w-md lg:max-w-lg bg-[#06529c] text-white rounded-lg p-3 shadow">
                    <p>${message.replace(/\n/g, '<br>')}</p>
                </div>
                <div class="ml-2 w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-[#FCB813]">
                    <i class="fa-solid fa-user-secret"></i>
                </div>`;
            if (chatWindow) chatWindow.appendChild(messageDiv);
        }

        function _renderBotMessage(message) {
            hideWelcomeMessage();
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex mb-4 message-animation';
            messageDiv.innerHTML = `
                <div class="mr-2 w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-[#FCB813]">
                    <i class="fa-solid fa-bug"></i>
                </div>
                <div class="max-w-xs md:max-w-md lg:max-w-lg bg-gray-700 text-gray-200 rounded-lg p-3 shadow">
                    <p>${message.replace(/\n/g, '<br>')}</p>
                </div>`;
            if (chatWindow) chatWindow.appendChild(messageDiv);
        }

        function addUserMessage(message) {
            currentChatMessages.push({ role: 'user', content: message });
            _renderUserMessage(message);
            if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight; 
            saveChatHistory();
        }
        
        function addBotMessage(message) {
            if (!currentChatMessages.find(m => m.role === 'assistant' && m.content === message)) {
                 currentChatMessages.push({ role: 'assistant', content: message });
            }
            _renderBotMessage(message);
            if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight; 
            saveChatHistory();
        }
        
        function showThinkingIndicator() {
            hideWelcomeMessage();
            if (document.getElementById('ai-thinking-indicator-shell')) return;

            const thinkingIndicatorShell = document.createElement('div');
            thinkingIndicatorShell.className = 'flex mb-4 message-animation';
            thinkingIndicatorShell.id = 'ai-thinking-indicator-shell'; 
            thinkingIndicatorShell.innerHTML = `
                <div class="mr-2 w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-[#FCB813]">
                    <i class="fa-solid fa-bug"></i>
                </div>
                <div class="max-w-xs md:max-w-md lg:max-w-lg bg-gray-700 text-gray-200 rounded-lg p-3 shadow">
                    <div id="ai-thinking-container">
                        <div class="typing-indicator" id="initial-typing-dots">
                            <span></span><span></span><span></span> 
                        </div>
                        <div id="thought-bubbles-area" class="mt-2 space-y-1">
                        </div>
                    </div>
                </div>`;
            if (chatWindow) chatWindow.appendChild(thinkingIndicatorShell);
            if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        
        function hideThinkingIndicator() {
            const thinkingIndicatorShell = document.getElementById('ai-thinking-indicator-shell');
            if (thinkingIndicatorShell) {
                thinkingIndicatorShell.remove();
            }
        }

        function addAIThought(thoughtText, thoughtId) {
            const thoughtBubblesArea = document.getElementById('thought-bubbles-area');
            if (thoughtBubblesArea) {
                const thoughtBubble = document.createElement('div');
                thoughtBubble.className = 'thought-bubble message-animation'; 
                thoughtBubble.textContent = thoughtText;
                thoughtBubble.dataset.thoughtId = thoughtId; 

                thoughtBubble.addEventListener('click', function() {
                    alert(`You clicked on thought: "${thoughtText}" (ID: ${thoughtId})`);
                    console.log("Thought clicked:", {id: thoughtId, text: thoughtText});
                });
                thoughtBubblesArea.appendChild(thoughtBubble);
                if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight; 
            }
        }
        
        async function sendMessageToBackend(message) {
            showThinkingIndicator(); 

            try {
                await new Promise(resolve => setTimeout(resolve, 300)); 
                const simulatedBackendResponse = {
                    thoughts: [
                        { id: "thought_1", text: "Query received: \"" + message.substring(0, 20) + (message.length > 20 ? "..." : "") + "\"" },
                        { id: "thought_2", text: "Analyzing context..." },
                        { id: "thought_3", text: "Consulting knowledge base..." },
                        { id: "thought_4", text: "Constructing response." }
                    ],
                    final_response: `Regarding your query about "${message.substring(0,30)}${message.length > 30 ? "..." : ""}", here is my assessment.`
                };

                if (simulatedBackendResponse.thoughts && simulatedBackendResponse.thoughts.length > 0) {
                    for (const thought of simulatedBackendResponse.thoughts) {
                        await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 300)); 
                        addAIThought(thought.text, thought.id);
                    }
                    await new Promise(resolve => setTimeout(resolve, 400)); 
                } else {
                     await new Promise(resolve => setTimeout(resolve, 800)); 
                }

                hideThinkingIndicator(); 
                addBotMessage(simulatedBackendResponse.final_response); 

            } catch (error) {
                console.error('Error processing AI request:', error);
                hideThinkingIndicator();
                addBotMessage("My apologies, I encountered an issue. Please try again.");
            }
        }
        
        function saveChatHistory() {
            localStorage.setItem('chatMessagesArray', JSON.stringify(currentChatMessages));
        }
        
        function loadChatHistory() {
            const savedMessages = localStorage.getItem('chatMessagesArray');
            if (chatWindow) chatWindow.innerHTML = ''; 
            currentChatMessages = []; 

            if (savedMessages) {
                currentChatMessages = JSON.parse(savedMessages);
                if (currentChatMessages.length > 0) {
                    currentChatMessages.forEach(msg => {
                        if (msg.role === 'user') _renderUserMessage(msg.content);
                        else if (msg.role === 'assistant') _renderBotMessage(msg.content);
                    });
                } else {
                     if (chatWindow) chatWindow.innerHTML = welcomeMessageHTML; 
                }
            } else {
                if (chatWindow) chatWindow.innerHTML = welcomeMessageHTML; 
            }

            const wm = document.getElementById('welcome-message');
            if (currentChatMessages.length > 0 && wm) {
                wm.style.display = 'none';
            } else if (wm) {
                wm.style.display = 'block';
            }
            if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight; 
        }
        
        if (userInput) {
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); 
                    if (chatForm) chatForm.dispatchEvent(new Event('submit')); 
                }
            });
        }
    });
    </script>
</body>
</html>